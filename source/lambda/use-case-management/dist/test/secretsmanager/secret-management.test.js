"use strict";
/**********************************************************************************************************************
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.                                                *
 *                                                                                                                    *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance    *
 *  with the License. A copy of the License is located at                                                             *
 *                                                                                                                    *
 *      http://www.apache.org/licenses/LICENSE-2.0                                                                    *
 *                                                                                                                    *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES *
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions    *
 *  and limitations under the License.                                                                                *
 *********************************************************************************************************************/
Object.defineProperty(exports, "__esModule", { value: true });
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const aws_sdk_client_mock_1 = require("aws-sdk-client-mock");
const use_case_1 = require("../../model/use-case");
const constants_1 = require("../../utils/constants");
const secret_management_1 = require("../../secretsmanager/secret-management");
describe('When testing performing secrets management tasks', () => {
    let config;
    let cfnParameters;
    let secretsmanagerMockedClient;
    let secretManagement;
    let useCase;
    beforeAll(() => {
        config = {
            ConversationMemoryType: 'DDBMemoryType',
            ConversationMemoryParams: 'ConversationMemoryParams',
            KnowledgeBaseType: 'Kendra',
            KnowledgeBaseParams: {
                NumberOfDocs: '5',
                ReturnSourceDocs: '5'
            },
            LlmParams: {
                ModelId: 'google/flan-t5-xxl',
                ModelParams: 'Param1',
                PromptTemplate: 'Prompt1',
                Streaming: true,
                Temperature: 0.1
            }
        };
        cfnParameters = new Map();
        cfnParameters.set('LLMProviderName', 'HuggingFace');
        process.env.AWS_SDK_USER_AGENT = `{ "customUserAgent": "AwsSolution/SO0276/v2.0.0" }`;
        process.env[constants_1.USE_CASE_API_KEY_SUFFIX_ENV_VAR] = 'api-key';
        secretsmanagerMockedClient = (0, aws_sdk_client_mock_1.mockClient)(client_secrets_manager_1.SecretsManagerClient);
        secretManagement = new secret_management_1.SecretManagement();
    });
    describe('When successfully invoking Commands', () => {
        beforeAll(() => {
            secretsmanagerMockedClient.on(client_secrets_manager_1.CreateSecretCommand).resolves({});
            secretsmanagerMockedClient.on(client_secrets_manager_1.DeleteSecretCommand).resolves({});
        });
        it('should create a new secret', async () => {
            await secretManagement.createSecret(new use_case_1.UseCase('fake-id', 'fake-test', 'Create a stack for test', cfnParameters, config, 'test-user', 'fake-template-name', 'Chat', 'fake-api-key'));
            let calls = secretsmanagerMockedClient.commandCalls(client_secrets_manager_1.CreateSecretCommand);
            expect(calls.length).toEqual(1);
            expect(calls[0].args[0].input.Name).toEqual('fake-id/api-key');
            expect(calls[0].args[0].input.SecretString).toEqual('fake-api-key');
        });
        it('should update a secrets value', async () => {
            await secretManagement.updateSecret(new use_case_1.UseCase('fake-id', 'fake-test', 'Create a stack for test', cfnParameters, config, 'test-user', 'fake-template-name', 'Chat', 'fake-api-key'));
            let calls = secretsmanagerMockedClient.commandCalls(client_secrets_manager_1.PutSecretValueCommand);
            expect(calls.length).toEqual(1);
            expect(calls[0].args[0].input.SecretId).toEqual('fake-id/api-key');
            expect(calls[0].args[0].input.SecretString).toEqual('fake-api-key');
        });
        it('should delete a secret', async () => {
            await secretManagement.deleteSecret(new use_case_1.UseCase('fake-id', 'fake-test', 'Create a stack for test', cfnParameters, config, 'test-user', 'fake-template-name', 'Chat'));
            let calls = secretsmanagerMockedClient.commandCalls(client_secrets_manager_1.DeleteSecretCommand);
            expect(calls.length).toEqual(1);
            expect(calls[0].args[0].input.SecretId).toEqual('fake-id/api-key');
        });
        afterEach(() => secretsmanagerMockedClient.reset());
        afterAll(() => {
            secretsmanagerMockedClient.reset();
        });
    });
    describe('When secrets manager errors out', () => {
        beforeAll(() => {
            secretsmanagerMockedClient.on(client_secrets_manager_1.CreateSecretCommand).rejects(new Error('Fake create error'));
            secretsmanagerMockedClient.on(client_secrets_manager_1.DeleteSecretCommand).rejects(new Error('Fake delete error'));
            secretsmanagerMockedClient.on(client_secrets_manager_1.PutSecretValueCommand).rejects(new Error('Fake update error'));
        });
        it('should return error if sm create fails', async () => {
            expect(await secretManagement
                .createSecret(new use_case_1.UseCase('fake-id', 'fake-test', 'Create a stack for test', cfnParameters, config, 'test-user', 'fake-template-name', 'Chat', 'fake-api-key'))
                .catch((error) => {
                expect(error).toBeInstanceOf(Error);
                expect(error.message).toEqual('Fake create error');
            }));
        });
        it('should return error if sm update fails', async () => {
            expect(await secretManagement
                .updateSecret(new use_case_1.UseCase('fake-id', 'fake-test', 'Create a stack for test', cfnParameters, config, 'test-user', 'fake-template-name', 'Chat', 'fake-api-key'))
                .catch((error) => {
                expect(error).toBeInstanceOf(Error);
                expect(error.message).toEqual('Fake update error');
            }));
        });
        it('should return an error if sm delete fails', async () => {
            expect(await secretManagement
                .deleteSecret(new use_case_1.UseCase('fake-id', 'fake-test', 'Create a stack for test', cfnParameters, config, 'test-user', 'fake-template-name', 'Chat', 'fake-api-key'))
                .catch((error) => {
                expect(error).toBeInstanceOf(Error);
                expect(error.message).toEqual('Fake delete error');
            }));
        });
        afterAll(() => {
            secretsmanagerMockedClient.reset();
        });
    });
    afterAll(() => {
        delete process.env.AWS_SDK_USER_AGENT;
        delete process.env[constants_1.USE_CASE_API_KEY_SUFFIX_ENV_VAR];
        secretsmanagerMockedClient.restore();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjcmV0LW1hbmFnZW1lbnQudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Rlc3Qvc2VjcmV0c21hbmFnZXIvc2VjcmV0LW1hbmFnZW1lbnQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O3VIQVd1SDs7QUFFdkgsNEVBS3lDO0FBQ3pDLDZEQUFpRDtBQUNqRCxtREFBK0M7QUFDL0MscURBQXdFO0FBQ3hFLDhFQUEwRTtBQUUxRSxRQUFRLENBQUMsa0RBQWtELEVBQUUsR0FBRyxFQUFFO0lBQzlELElBQUksTUFBVyxDQUFDO0lBQ2hCLElBQUksYUFBa0MsQ0FBQztJQUN2QyxJQUFJLDBCQUErQixDQUFDO0lBQ3BDLElBQUksZ0JBQWtDLENBQUM7SUFDdkMsSUFBSSxPQUFnQixDQUFDO0lBRXJCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDWCxNQUFNLEdBQUc7WUFDTCxzQkFBc0IsRUFBRSxlQUFlO1lBQ3ZDLHdCQUF3QixFQUFFLDBCQUEwQjtZQUNwRCxpQkFBaUIsRUFBRSxRQUFRO1lBQzNCLG1CQUFtQixFQUFFO2dCQUNqQixZQUFZLEVBQUUsR0FBRztnQkFDakIsZ0JBQWdCLEVBQUUsR0FBRzthQUN4QjtZQUNELFNBQVMsRUFBRTtnQkFDUCxPQUFPLEVBQUUsb0JBQW9CO2dCQUM3QixXQUFXLEVBQUUsUUFBUTtnQkFDckIsY0FBYyxFQUFFLFNBQVM7Z0JBQ3pCLFNBQVMsRUFBRSxJQUFJO2dCQUNmLFdBQVcsRUFBRSxHQUFHO2FBQ25CO1NBQ0osQ0FBQztRQUNGLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztRQUMxQyxhQUFhLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRXBELE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEdBQUcsb0RBQW9ELENBQUM7UUFDdEYsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQ0FBK0IsQ0FBQyxHQUFHLFNB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LE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDdkQsQ0FBQyxDQUFDLENBQ1QsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO1FBRUgsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUNWLDBCQUEwQixDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsR0FBRyxFQUFFO1FBQ1YsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO1FBQ3RDLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQywyQ0FBK0IsQ0FBQyxDQUFDO1FBRXBELDBCQUEwQixDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3pDLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICpcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSAgICAqXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTICpcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyAgICAqXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuaW1wb3J0IHtcbiAgICBTZWNyZXRzTWFuYWdlckNsaWVudCxcbiAgICBDcmVhdGVTZWNyZXRDb21tYW5kLFxuICAgIFB1dFNlY3JldFZhbHVlQ29tbWFuZCxcbiAgICBEZWxldGVTZWNyZXRDb21tYW5kXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXInO1xuaW1wb3J0IHsgbW9ja0NsaWVudCB9IGZyb20gJ2F3cy1zZGstY2xpZW50LW1vY2snO1xuaW1wb3J0IHsgVXNlQ2FzZSB9IGZyb20gJy4uLy4uL21vZGVsL3VzZS1jYXNlJztcbmltcG9ydCB7IFVTRV9DQVNFX0FQSV9LRVlfU1VGRklYX0VOVl9WQVIgfSBmcm9tICcuLi8uLi91dGlscy9jb25zdGFudHMnO1xuaW1wb3J0IHsgU2VjcmV0TWFuYWdlbWVudCB9IGZyb20gJy4uLy4uL3NlY3JldHNtYW5hZ2VyL3NlY3JldC1tYW5hZ2VtZW50JztcblxuZGVzY3JpYmUoJ1doZW4gdGVzdGluZyBwZXJmb3JtaW5nIHNlY3JldHMgbWFuYWdlbWVudCB0YXNrcycsICgpID0+IHtcbiAgICBsZXQgY29uZmlnOiBhbnk7XG4gICAgbGV0IGNmblBhcmFtZXRlcnM6IE1hcDxzdHJpbmcsIHN0cmluZz47XG4gICAgbGV0IHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50OiBhbnk7XG4gICAgbGV0IHNlY3JldE1hbmFnZW1lbnQ6IFNlY3JldE1hbmFnZW1lbnQ7XG4gICAgbGV0IHVzZUNhc2U6IFVzZUNhc2U7XG5cbiAgICBiZWZvcmVBbGwoKCkgPT4ge1xuICAgICAgICBjb25maWcgPSB7XG4gICAgICAgICAgICBDb252ZXJzYXRpb25NZW1vcnlUeXBlOiAnRERCTWVtb3J5VHlwZScsXG4gICAgICAgICAgICBDb252ZXJzYXRpb25NZW1vcnlQYXJhbXM6ICdDb252ZXJzYXRpb25NZW1vcnlQYXJhbXMnLFxuICAgICAgICAgICAgS25vd2xlZGdlQmFzZVR5cGU6ICdLZW5kcmEnLFxuICAgICAgICAgICAgS25vd2xlZGdlQmFzZVBhcmFtczoge1xuICAgICAgICAgICAgICAgIE51bWJlck9mRG9jczogJzUnLFxuICAgICAgICAgICAgICAgIFJldHVyblNvdXJjZURvY3M6ICc1J1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIExsbVBhcmFtczoge1xuICAgICAgICAgICAgICAgIE1vZGVsSWQ6ICdnb29nbGUvZmxhbi10NS14eGwnLFxuICAgICAgICAgICAgICAgIE1vZGVsUGFyYW1zOiAnUGFyYW0xJyxcbiAgICAgICAgICAgICAgICBQcm9tcHRUZW1wbGF0ZTogJ1Byb21wdDEnLFxuICAgICAgICAgICAgICAgIFN0cmVhbWluZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICBUZW1wZXJhdHVyZTogMC4xXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGNmblBhcmFtZXRlcnMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICAgICAgICBjZm5QYXJhbWV0ZXJzLnNldCgnTExNUHJvdmlkZXJOYW1lJywgJ0h1Z2dpbmdGYWNlJyk7XG5cbiAgICAgICAgcHJvY2Vzcy5lbnYuQVdTX1NES19VU0VSX0FHRU5UID0gYHsgXCJjdXN0b21Vc2VyQWdlbnRcIjogXCJBd3NTb2x1dGlvbi9TTzAyNzYvdjIuMC4wXCIgfWA7XG4gICAgICAgIHByb2Nlc3MuZW52W1VTRV9DQVNFX0FQSV9LRVlfU1VGRklYX0VOVl9WQVJdID0gJ2FwaS1rZXknO1xuXG4gICAgICAgIHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50ID0gbW9ja0NsaWVudChTZWNyZXRzTWFuYWdlckNsaWVudCk7XG5cbiAgICAgICAgc2VjcmV0TWFuYWdlbWVudCA9IG5ldyBTZWNyZXRNYW5hZ2VtZW50KCk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnV2hlbiBzdWNjZXNzZnVsbHkgaW52b2tpbmcgQ29tbWFuZHMnLCAoKSA9PiB7XG4gICAgICAgIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgICAgICAgICBzZWNyZXRzbWFuYWdlck1vY2tlZENsaWVudC5vbihDcmVhdGVTZWNyZXRDb21tYW5kKS5yZXNvbHZlcyh7fSk7XG4gICAgICAgICAgICBzZWNyZXRzbWFuYWdlck1vY2tlZENsaWVudC5vbihEZWxldGVTZWNyZXRDb21tYW5kKS5yZXNvbHZlcyh7fSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgbmV3IHNlY3JldCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHNlY3JldE1hbmFnZW1lbnQuY3JlYXRlU2VjcmV0KFxuICAgICAgICAgICAgICAgIG5ldyBVc2VDYXNlKFxuICAgICAgICAgICAgICAgICAgICAnZmFrZS1pZCcsXG4gICAgICAgICAgICAgICAgICAgICdmYWtlLXRlc3QnLFxuICAgICAgICAgICAgICAgICAgICAnQ3JlYXRlIGEgc3RhY2sgZm9yIHRlc3QnLFxuICAgICAgICAgICAgICAgICAgICBjZm5QYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICAgICAgICAgICd0ZXN0LXVzZXInLFxuICAgICAgICAgICAgICAgICAgICAnZmFrZS10ZW1wbGF0ZS1uYW1lJyxcbiAgICAgICAgICAgICAgICAgICAgJ0NoYXQnLFxuICAgICAgICAgICAgICAgICAgICAnZmFrZS1hcGkta2V5J1xuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGxldCBjYWxscyA9IHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50LmNvbW1hbmRDYWxscyhDcmVhdGVTZWNyZXRDb21tYW5kKTtcbiAgICAgICAgICAgIGV4cGVjdChjYWxscy5sZW5ndGgpLnRvRXF1YWwoMSk7XG4gICAgICAgICAgICBleHBlY3QoY2FsbHNbMF0uYXJnc1swXS5pbnB1dC5OYW1lKS50b0VxdWFsKCdmYWtlLWlkL2FwaS1rZXknKTtcbiAgICAgICAgICAgIGV4cGVjdChjYWxsc1swXS5hcmdzWzBdLmlucHV0LlNlY3JldFN0cmluZykudG9FcXVhbCgnZmFrZS1hcGkta2V5Jyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgdXBkYXRlIGEgc2VjcmV0cyB2YWx1ZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHNlY3JldE1hbmFnZW1lbnQudXBkYXRlU2VjcmV0KFxuICAgICAgICAgICAgICAgIG5ldyBVc2VDYXNlKFxuICAgICAgICAgICAgICAgICAgICAnZmFrZS1pZCcsXG4gICAgICAgICAgICAgICAgICAgICdmYWtlLXRlc3QnLFxuICAgICAgICAgICAgICAgICAgICAnQ3JlYXRlIGEgc3RhY2sgZm9yIHRlc3QnLFxuICAgICAgICAgICAgICAgICAgICBjZm5QYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICAgICAgICAgICd0ZXN0LXVzZXInLFxuICAgICAgICAgICAgICAgICAgICAnZmFrZS10ZW1wbGF0ZS1uYW1lJyxcbiAgICAgICAgICAgICAgICAgICAgJ0NoYXQnLFxuICAgICAgICAgICAgICAgICAgICAnZmFrZS1hcGkta2V5J1xuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGxldCBjYWxscyA9IHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50LmNvbW1hbmRDYWxscyhQdXRTZWNyZXRWYWx1ZUNvbW1hbmQpO1xuICAgICAgICAgICAgZXhwZWN0KGNhbGxzLmxlbmd0aCkudG9FcXVhbCgxKTtcbiAgICAgICAgICAgIGV4cGVjdChjYWxsc1swXS5hcmdzWzBdLmlucHV0LlNlY3JldElkKS50b0VxdWFsKCdmYWtlLWlkL2FwaS1rZXknKTtcbiAgICAgICAgICAgIGV4cGVjdChjYWxsc1swXS5hcmdzWzBdLmlucHV0LlNlY3JldFN0cmluZykudG9FcXVhbCgnZmFrZS1hcGkta2V5Jyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZGVsZXRlIGEgc2VjcmV0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgc2VjcmV0TWFuYWdlbWVudC5kZWxldGVTZWNyZXQoXG4gICAgICAgICAgICAgICAgbmV3IFVzZUNhc2UoXG4gICAgICAgICAgICAgICAgICAgICdmYWtlLWlkJyxcbiAgICAgICAgICAgICAgICAgICAgJ2Zha2UtdGVzdCcsXG4gICAgICAgICAgICAgICAgICAgICdDcmVhdGUgYSBzdGFjayBmb3IgdGVzdCcsXG4gICAgICAgICAgICAgICAgICAgIGNmblBhcmFtZXRlcnMsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgJ3Rlc3QtdXNlcicsXG4gICAgICAgICAgICAgICAgICAgICdmYWtlLXRlbXBsYXRlLW5hbWUnLFxuICAgICAgICAgICAgICAgICAgICAnQ2hhdCdcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBsZXQgY2FsbHMgPSBzZWNyZXRzbWFuYWdlck1vY2tlZENsaWVudC5jb21tYW5kQ2FsbHMoRGVsZXRlU2VjcmV0Q29tbWFuZCk7XG4gICAgICAgICAgICBleHBlY3QoY2FsbHMubGVuZ3RoKS50b0VxdWFsKDEpO1xuICAgICAgICAgICAgZXhwZWN0KGNhbGxzWzBdLmFyZ3NbMF0uaW5wdXQuU2VjcmV0SWQpLnRvRXF1YWwoJ2Zha2UtaWQvYXBpLWtleScpO1xuICAgICAgICB9KTtcblxuICAgICAgICBhZnRlckVhY2goKCkgPT4gc2VjcmV0c21hbmFnZXJNb2NrZWRDbGllbnQucmVzZXQoKSk7XG5cbiAgICAgICAgYWZ0ZXJBbGwoKCkgPT4ge1xuICAgICAgICAgICAgc2VjcmV0c21hbmFnZXJNb2NrZWRDbGllbnQucmVzZXQoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnV2hlbiBzZWNyZXRzIG1hbmFnZXIgZXJyb3JzIG91dCcsICgpID0+IHtcbiAgICAgICAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICAgICAgICAgIHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50Lm9uKENyZWF0ZVNlY3JldENvbW1hbmQpLnJlamVjdHMobmV3IEVycm9yKCdGYWtlIGNyZWF0ZSBlcnJvcicpKTtcbiAgICAgICAgICAgIHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50Lm9uKERlbGV0ZVNlY3JldENvbW1hbmQpLnJlamVjdHMobmV3IEVycm9yKCdGYWtlIGRlbGV0ZSBlcnJvcicpKTtcbiAgICAgICAgICAgIHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50Lm9uKFB1dFNlY3JldFZhbHVlQ29tbWFuZCkucmVqZWN0cyhuZXcgRXJyb3IoJ0Zha2UgdXBkYXRlIGVycm9yJykpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBlcnJvciBpZiBzbSBjcmVhdGUgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoXG4gICAgICAgICAgICAgICAgYXdhaXQgc2VjcmV0TWFuYWdlbWVudFxuICAgICAgICAgICAgICAgICAgICAuY3JlYXRlU2VjcmV0KFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFVzZUNhc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Zha2UtaWQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmYWtlLXRlc3QnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdDcmVhdGUgYSBzdGFjayBmb3IgdGVzdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ZuUGFyYW1ldGVycyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Rlc3QtdXNlcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Zha2UtdGVtcGxhdGUtbmFtZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NoYXQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmYWtlLWFwaS1rZXknXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihFcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoZXJyb3IubWVzc2FnZSkudG9FcXVhbCgnRmFrZSBjcmVhdGUgZXJyb3InKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGVycm9yIGlmIHNtIHVwZGF0ZSBmYWlscycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGV4cGVjdChcbiAgICAgICAgICAgICAgICBhd2FpdCBzZWNyZXRNYW5hZ2VtZW50XG4gICAgICAgICAgICAgICAgICAgIC51cGRhdGVTZWNyZXQoXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgVXNlQ2FzZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmFrZS1pZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Zha2UtdGVzdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NyZWF0ZSBhIHN0YWNrIGZvciB0ZXN0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZm5QYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGVzdC11c2VyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmFrZS10ZW1wbGF0ZS1uYW1lJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQ2hhdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Zha2UtYXBpLWtleSdcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleHBlY3QoZXJyb3IpLnRvQmVJbnN0YW5jZU9mKEVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChlcnJvci5tZXNzYWdlKS50b0VxdWFsKCdGYWtlIHVwZGF0ZSBlcnJvcicpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gYW4gZXJyb3IgaWYgc20gZGVsZXRlIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KFxuICAgICAgICAgICAgICAgIGF3YWl0IHNlY3JldE1hbmFnZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgLmRlbGV0ZVNlY3JldChcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBVc2VDYXNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmYWtlLWlkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmFrZS10ZXN0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQ3JlYXRlIGEgc3RhY2sgZm9yIHRlc3QnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNmblBhcmFtZXRlcnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0ZXN0LXVzZXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmYWtlLXRlbXBsYXRlLW5hbWUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdDaGF0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmFrZS1hcGkta2V5J1xuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVjdChlcnJvcikudG9CZUluc3RhbmNlT2YoRXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0KGVycm9yLm1lc3NhZ2UpLnRvRXF1YWwoJ0Zha2UgZGVsZXRlIGVycm9yJyk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICBhZnRlckFsbCgoKSA9PiB7XG4gICAgICAgICAgICBzZWNyZXRzbWFuYWdlck1vY2tlZENsaWVudC5yZXNldCgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGFmdGVyQWxsKCgpID0+IHtcbiAgICAgICAgZGVsZXRlIHByb2Nlc3MuZW52LkFXU19TREtfVVNFUl9BR0VOVDtcbiAgICAgICAgZGVsZXRlIHByb2Nlc3MuZW52W1VTRV9DQVNFX0FQSV9LRVlfU1VGRklYX0VOVl9WQVJdO1xuXG4gICAgICAgIHNlY3JldHNtYW5hZ2VyTW9ja2VkQ2xpZW50LnJlc3RvcmUoKTtcbiAgICB9KTtcbn0pO1xuIl19